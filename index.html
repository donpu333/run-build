<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Application</title>
    <!-- Подключение внешних стилей, если есть -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="chart-container"></div>
    <!-- Подключение вашего JavaScript файла -->
    <script src="index-C4Jf-lH9.js"></script>
    <script>
        // После инициализации графика
        const chart = initChart('chart-container');

        // Оптимизированное сохранение с дебаунсом
        let saveTimeout;
        function debounceSave() {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveChartState, 1000);
        }

        function saveChartState() {
          try {
            const state = {
              styles: chart.getStyles(),
              drawings: chart.getAllShapes().map(drawing => {
                // Упрощаем объекты для хранения
                return {
                  name: drawing.name,
                  points: drawing.points,
                  options: drawing.options,
                  lock: drawing.lock,
                  visible: drawing.visible
                };
              }),
              indicators: chart.getTechnicalIndicatorInstances().map(ind => ({
                name: ind.name,
                visible: ind.visible,
                calcParams: ind.calcParams
              })),
              timeframe: chart.getTimeScale().getBarTime(),
              symbol: chart.getSymbol(),
              viewRange: chart.getTimeScale().getVisibleRange()
            };

            localStorage.setItem('binanceChartState', JSON.stringify(state));
          } catch (error) {
            console.error('Error saving chart state:', error);
          }
        }

        function loadChartState() {
          try {
            const savedState = localStorage.getItem('binanceChartState');
            if (savedState) {
              const state = JSON.parse(savedState);

              // Восстановление стилей
              if (state.styles) {
                chart.setStyles(state.styles);
              }

              // Восстановление объектов
              if (state.drawings && state.drawings.length > 0) {
                // Сначала очищаем все существующие объекты
                chart.getAllShapes().forEach(drawing => {
                  chart.removeShape(drawing.id);
                });

                // Добавляем сохраненные объекты
                state.drawings.forEach(drawing => {
                  chart.createShape({
                    name: drawing.name,
                    points: drawing.points,
                    options: drawing.options,
                    lock: drawing.lock,
                    visible: drawing.visible !== false
                  });
                });
              }

              // Восстановление индикаторов
              if (state.indicators && state.indicators.length > 0) {
                chart.getTechnicalIndicatorInstances().forEach(ind => {
                  chart.removeTechnicalIndicator(ind.id);
                });

                state.indicators.forEach(indicator => {
                  chart.createTechnicalIndicator(
                    indicator.name,
                    indicator.visible !== false,
                    indicator.calcParams || []
                  );
                });
              }

              // Восстановление таймфрейма
              if (state.timeframe) {
                chart.setBarTime(state.timeframe);
              }

              // Восстановление символа (если поддерживается)
              if (state.symbol) {
                chart.setSymbol(state.symbol);
              }

              // Восстановление видимого диапазона
              if (state.viewRange) {
                setTimeout(() => {
                  chart.getTimeScale().setVisibleRange(state.viewRange);
                }, 500);
              }
            }
          } catch (error) {
            console.error('Error loading chart state:', error);
            // В случае ошибки очищаем сохраненное состояние
            localStorage.removeItem('binanceChartState');
          }
        }

        // Подписываемся на события
        const eventsToSubscribe = [
          'onSymbolChange',
          'onTimeScaleChange',
          'onDrawShape',
          'onAdjustShape',
          'onDeleteShape',
          'onTechnicalIndicatorChange',
          'onPaneDrag',
          'onZoom',
          'onScroll'
        ];

        eventsToSubscribe.forEach(event => {
          chart.subscribeAction(event, debounceSave);
        });

        // Загружаем состояние при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadChartState);

        // Также можно добавить кнопку для сброса настроек
        function resetChartSettings() {
          if (confirm('Вы уверены, что хотите сбросить все настройки графика?')) {
            localStorage.removeItem('binanceChartState');
            location.reload();
          }
        }
    </script>
</body>
</html>
